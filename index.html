<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resumen Diario ‚Äì Tribunal de Faltas</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primario:   #1a3a5c;
            --secundario: #2e6da4;
            --acento:     #e8a020;
            --exito:      #27ae60;
            --error:      #e74c3c;
            --fondo:      #f0f4f8;
            --borde:      #dce3ea;
            --texto:      #2c3e50;
            --suave:      #7f8c8d;
            --transito:   #2e6da4;
            --transito-sab: #1a5276;
            --defensa:    #6c3483;
            --catastro:   #1a7a4a;
            --salud:      #1a8a6c;
            --tmf:        #b7360e;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--fondo); color: var(--texto); font-size: 15px; }

        /* LOGIN */
        #pantalla-login {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, var(--primario), var(--secundario));
        }
        .login-box {
            background: white; border-radius: 12px; padding: 40px;
            text-align: center; max-width: 400px; width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        .login-box .logo { font-size: 52px; margin-bottom: 12px; }
        .login-box h1 { font-size: 22px; color: var(--primario); margin-bottom: 6px; }
        .login-box p  { color: var(--suave); font-size: 14px; margin-bottom: 8px; }
        .error-acceso {
            display:none; background:#fdecea; color:#c0392b;
            border-radius:8px; padding:12px 16px; margin-top:16px; font-size:13px;
        }

        /* APP */
        #pantalla-app { display: none; min-height: 100vh; }

        header {
            background: var(--primario); color: white;
            padding: 12px 20px; display: flex; align-items: center;
            justify-content: space-between; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .header-titulo { display: flex; align-items: center; gap: 10px; }
        .header-titulo h1 { font-size: 15px; font-weight: 700; }
        .header-titulo p  { font-size: 11px; opacity: 0.7; margin-top: 2px; }
        .usuario-info { display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .usuario-info img { width: 30px; height: 30px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); }
        .usuario-nombre { display: none; }
        .btn-salir {
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px;
        }

        .contenido { padding: 16px; max-width: 1300px; margin: 0 auto; }

        /* BARRA FECHA */
        .fecha-bar {
            background: white; border-radius: 10px; padding: 12px 16px;
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); flex-wrap: wrap;
        }
        .fecha-bar label { font-size: 11px; font-weight: 700; color: var(--suave); text-transform: uppercase; display: block; margin-bottom: 2px; }
        .fecha-bar input[type="date"] { border: 1.5px solid var(--borde); border-radius: 6px; padding: 6px 10px; font-size: 14px; font-weight: 600; color: var(--primario); }
        .fecha-bar strong { font-size: 14px; color: var(--primario); }

        .btn {
            padding: 7px 14px; border-radius: 6px; border: none; font-size: 13px;
            font-weight: 600; cursor: pointer; text-decoration: none;
            display: inline-flex; align-items: center; gap: 5px;
        }
        .btn-hoy { background: var(--acento); color: white; margin-left: auto; }
        .btn-nav { background: var(--fondo); color: var(--texto); border: 1.5px solid var(--borde); }
        .btn-nav:hover { border-color: var(--secundario); color: var(--secundario); }

        /* EXPORT BAR */
        .export-bar { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
        .btn-exp {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 7px 12px; border-radius: 6px; border: 1.5px solid;
            font-size: 13px; font-weight: 600; cursor: pointer; background: white;
            font-family: inherit; transition: all 0.15s;
        }
        .btn-exp.imp  { border-color: var(--primario); color: var(--primario); }
        .btn-exp.imp:hover  { background: var(--primario); color: white; }
        .btn-exp.pdf  { border-color: #c0392b; color: #c0392b; }
        .btn-exp.pdf:hover  { background: #c0392b; color: white; }
        .btn-exp.xls  { border-color: #27ae60; color: #27ae60; }
        .btn-exp.xls:hover  { background: #27ae60; color: white; }

        /* ESTADO MESAS */
        .estado-mesas { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
        .estado-chip {
            display: flex; align-items: center; gap: 7px;
            padding: 7px 13px; border-radius: 20px; background: white;
            border: 2px solid; font-size: 13px; font-weight: 600;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .dot { width: 9px; height: 9px; border-radius: 50%; }

        /* CARD */
        .card { background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 16px; overflow: hidden; }
        .card-header { padding: 14px 18px; border-bottom: 1px solid var(--borde); font-size: 15px; font-weight: 700; color: var(--primario); }

        /* TABLA COMPARATIVA */
        .tabla-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tabla-resumen { width: 100%; border-collapse: collapse; font-size: 15px; }
        .tabla-resumen thead { position: sticky; top: 0; z-index: 5; }
        .tabla-resumen th {
            padding: 13px 14px; text-align: center;
            font-size: 13px; font-weight: 700; color: white;
        }
        .tabla-resumen th.col-label { text-align: left; min-width: 190px; background: #0c1f35; font-size: 13px; }
        .tabla-resumen th.th-ts  { background: var(--transito); }
        .tabla-resumen th.th-tsab{ background: var(--transito-sab); }
        .tabla-resumen th.th-def { background: var(--defensa); }
        .tabla-resumen th.th-cat { background: var(--catastro); }
        .tabla-resumen th.th-sal { background: var(--salud); }
        .tabla-resumen td {
            padding: 10px 14px; border-bottom: 1px solid var(--borde);
            text-align: center; font-size: 15px;
        }
        .tabla-resumen td.col-label {
            text-align: left; font-size: 14px; font-weight: 600;
            background: #f8fafc; border-right: 2px solid var(--borde);
        }
        .tabla-resumen td.sub { padding-left: 28px; color: var(--suave); font-size: 13px; }
        .tabla-resumen .sec-titulo td {
            font-size: 12px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px; padding: 7px 14px;
        }
        .sec-actas td      { background: #dbeafe; color: #1e40af; }
        .sec-secuestros td { background: #fee2e2; color: #991b1b; }
        .sec-atencion td   { background: #d1fae5; color: #065f46; }
        .sec-sistemas td   { background: #ede9fe; color: #4c1d95; }
        .sec-juzgados td   { background: #fef3c7; color: #92400e; }
        .tabla-resumen tr:hover td { background: #f0f7ff; }
        .tabla-resumen tr:hover td.col-label { background: #e4eef9; }
        .sec-titulo:hover td { background: inherit !important; }
        .vg { font-size: 20px; font-weight: 700; color: var(--primario); }
        .sd { color: #bdc3c7; font-size: 13px; }

        /* TMF */
        .tmf-header {
            background: linear-gradient(135deg, #b7360e, #e74c3c);
            color: white; padding: 16px 20px;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
        }
        .tmf-header h2 { font-size: 17px; color: white; }
        .tmf-header p  { font-size: 12px; opacity: 0.8; margin-top: 3px; }
        .tmf-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 14px; padding: 18px; }
        .tmf-bloque { background: var(--fondo); border-radius: 8px; padding: 14px; }
        .tmf-bloque-titulo { font-size: 11px; font-weight: 700; color: #b7360e; text-transform: uppercase; margin-bottom: 10px; }
        .tmf-fila { display: flex; justify-content: space-between; align-items: center; padding: 7px 0; border-bottom: 1px solid var(--borde); font-size: 13px; }
        .tmf-fila:last-child { border-bottom: none; }
        .tmf-fila .lbl { color: var(--suave); }
        .tmf-fila .num { font-size: 20px; font-weight: 700; color: var(--primario); }
        .tmf-juzgados { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 0 18px 18px; }
        .juz-box { background: var(--fondo); border-radius: 8px; padding: 14px; text-align: center; }
        .juz-titulo { font-size: 12px; font-weight: 700; color: var(--suave); margin-bottom: 10px; }
        .juz-numeros { display: flex; gap: 12px; justify-content: center; align-items: center; }
        .juz-num { font-size: 24px; font-weight: 700; }
        .juz-num.ing  { color: var(--primario); }
        .juz-num.reas { color: var(--acento); }
        .juz-lbl { font-size: 11px; color: var(--suave); }
        .juz-sep { border-left: 1px solid var(--borde); height: 32px; }

        /* LOADING */
        #loading { text-align: center; padding: 60px 20px; color: var(--suave); font-size: 16px; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--borde); border-top-color: var(--secundario); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
        .alert-warning { background: #fef9e7; color: #9a7d0a; border-left: 4px solid var(--acento); }

        /* FOOTER */
        footer {
            text-align: center; padding: 16px 20px;
            color: var(--suave); font-size: 12px;
            border-top: 1px solid var(--borde); margin-top: 8px;
            background: white;
        }
        footer strong { color: var(--primario); }

        /* PRINT */
        @media print {
            .export-bar, .btn-salir, header .usuario-info, .btn-nav, .btn-hoy { display: none !important; }
            .tabla-wrapper { overflow: visible !important; }
            .tabla-resumen thead { position: static !important; }
            body { font-size: 11px; }
            .tabla-resumen th { font-size: 10px; padding: 5px 7px; }
            .tabla-resumen td { font-size: 11px; padding: 5px 7px; }
            .vg { font-size: 13px !important; }
            .card { box-shadow: none; border: 1px solid #ddd; }
            @page { margin: 1cm; }
        }

        /* RESPONSIVE MOBILE */
        @media (max-width: 640px) {
            .contenido { padding: 10px; }
            .header-titulo h1 { font-size: 13px; }
            .header-titulo p  { display: none; }
            .usuario-nombre { display: none !important; }

            .fecha-bar { gap: 8px; padding: 10px 12px; }
            .fecha-bar strong { font-size: 13px; }
            .fecha-bar input[type="date"] { font-size: 13px; }

            .export-bar .btn-exp span { display: none; }
            .btn-exp { padding: 7px 10px; }

            .estado-chip { font-size: 12px; padding: 6px 10px; }

            /* Tabla - scroll horizontal en mobile */
            .tabla-wrapper { border: 1px solid var(--borde); border-radius: 8px; }
            .tabla-resumen th { font-size: 11px; padding: 9px 8px; white-space: nowrap; }
            .tabla-resumen td { font-size: 13px; padding: 8px; }
            .tabla-resumen td.col-label { font-size: 12px; min-width: 140px; }
            .vg { font-size: 16px !important; }

            /* TMF mobile */
            .tmf-grid { grid-template-columns: 1fr 1fr; gap: 10px; padding: 12px; }
            .tmf-juzgados { grid-template-columns: 1fr; padding: 0 12px 12px; }
            .tmf-fila .num { font-size: 17px; }
            .juz-num { font-size: 20px; }
        }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="pantalla-login">
    <div class="login-box">
        <div class="logo">‚öñÔ∏è</div>
        <h1>Tribunal de Faltas</h1>
        <p>Mesas de Entrada ¬∑ Resumen Diario</p>
        <p style="font-size:12px;color:#aaa;margin-bottom:20px;">Municipalidad de San Miguel de Tucum√°n</p>
        <div id="google-btn"></div>
        <div class="error-acceso" id="error-acceso">
            ‚õî Tu cuenta no tiene acceso a este sistema.<br>
            Contact√° al administrador para solicitar acceso.
        </div>
    </div>
</div>

<!-- APP -->
<div id="pantalla-app">
    <header>
        <div class="header-titulo">
            <span style="font-size:22px;">‚öñÔ∏è</span>
            <div>
                <h1>Tribunal de Faltas ‚Äì Mesas de Entrada</h1>
                <p>Resumen Diario ¬∑ Municipalidad de San Miguel de Tucum√°n</p>
            </div>
        </div>
        <div class="usuario-info">
            <img id="user-avatar" src="" alt="">
            <span id="user-name" class="usuario-nombre"></span>
            <button class="btn-salir" onclick="cerrarSesion()">Salir</button>
        </div>
    </header>

    <div class="contenido">
        <div id="loading"><div class="spinner"></div>Cargando datos...</div>
        <div id="contenido-datos" style="display:none;"></div>
    </div>
</div>

<script>
const GOOGLE_CLIENT_ID = '1083295097277-qb6ug0psqmkof8filklhv4rifdphiitg.apps.googleusercontent.com';
const SPREADSHEET_ID   = '1HoHYklZlysMh77WybuZc_28QyczXrfq923J2JxfYtZc';
const API_KEY          = 'AIzaSyATf67anKIAFp8WRohpyb9vsIpe3-0jFIo';
const EMAILS_PERMITIDOS = [];

let fechaActual = hoy();

window.onload = function() {
    google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: manejarLogin, auto_select: false });
    google.accounts.id.renderButton(document.getElementById('google-btn'), { theme: 'outline', size: 'large', text: 'signin_with', locale: 'es', width: 300 });
    const sesion = sessionStorage.getItem('tmf_user');
    if (sesion) { const u = JSON.parse(sesion); mostrarApp(u); cargarDatos(fechaActual); }
};

function manejarLogin(response) {
    const payload = JSON.parse(atob(response.credential.split('.')[1]));
    const email = payload.email;
    if (EMAILS_PERMITIDOS.length > 0 && !EMAILS_PERMITIDOS.includes(email)) {
        document.getElementById('error-acceso').style.display = 'block'; return;
    }
    const usuario = { email, nombre: payload.name, avatar: payload.picture };
    sessionStorage.setItem('tmf_user', JSON.stringify(usuario));
    mostrarApp(usuario);
    cargarDatos(fechaActual);
}

function mostrarApp(usuario) {
    document.getElementById('pantalla-login').style.display = 'none';
    document.getElementById('pantalla-app').style.display = 'block';
    document.getElementById('user-name').textContent = usuario.nombre;
    document.getElementById('user-avatar').src = usuario.avatar;
}

function cerrarSesion() {
    sessionStorage.removeItem('tmf_user');
    google.accounts.id.disableAutoSelect();
    location.reload();
}

async function cargarDatos(fecha) {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('contenido-datos').style.display = 'none';
    const nombreHoja = formatearFechaHoja(fecha);
    try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(nombreHoja)}!A1:G100?key=${API_KEY}`;
        const resp = await fetch(url);
        if (!resp.ok) { mostrarSinDatos(fecha); return; }
        const data = await resp.json();
        if (!data.values || data.values.length < 5) { mostrarSinDatos(fecha); return; }
        renderizarDatos(data.values, fecha);
    } catch(e) { mostrarSinDatos(fecha); }
}

function formatearFechaHoja(fecha) {
    const [y,m,d] = fecha.split('-'); return `${d}/${m}/${y}`;
}

function formatearFechaLegible(fecha) {
    const dias  = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
    const meses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
    const f = new Date(fecha + 'T12:00:00');
    return `${dias[f.getDay()]} ${f.getDate()} de ${meses[f.getMonth()]} de ${f.getFullYear()}`;
}

function hoy() { return new Date().toISOString().split('T')[0]; }

// Col indices: A=0 Indicador, B=1 Tr√°nsito Semana, C=2 Tr√°nsito S√°bado, D=3 Defensa, E=4 Catastro, F=5 Salud, G=6 Total
function parsearDatos(filas) {
    const datos = {};
    filas.forEach(fila => {
        const ind = (fila[0] || '').trim();
        if (!ind || ind.startsWith('---') || ind.startsWith('===') || ind === 'INDICADOR') return;
        datos[ind] = {
            ts:  fila[1] || '‚Äî',
            tsab:fila[2] || '‚Äî',
            def: fila[3] || '‚Äî',
            cat: fila[4] || '‚Äî',
            sal: fila[5] || '‚Äî',
            tot: fila[6] || '',
            cant:fila[1] || '0',
        };
    });
    return datos;
}

function v(datos, key, col) {
    if (!datos[key]) return '<span class="sd">‚Äî</span>';
    const val = datos[key][col];
    if (!val || val === '‚Äî' || val === '0') return '<span class="sd">‚Äî</span>';
    return val;
}

function vg(datos, key, col) {
    if (!datos[key]) return '<span class="sd">‚Äî</span>';
    const val = datos[key][col];
    if (!val || val === '‚Äî' || val === '0') return '<span class="sd">‚Äî</span>';
    return `<span class="vg">${val}</span>`;
}

function vc(datos, key) {
    if (!datos[key]) return '0';
    return datos[key]['cant'] || '0';
}

function renderizarDatos(filas, fecha) {
    const datos = parsearDatos(filas);

    const estados = {
        'üöó Tr√°nsito': datos['Total actas ingresadas']?.ts !== '‚Äî',
        'üöî Tr. S√°bado': datos['Total actas ingresadas']?.tsab !== '‚Äî',
        'üìã TMF':       datos['Actas ingresadas'] !== undefined,
        'üõ°Ô∏è Def. Civil':datos['Total actas ingresadas']?.def !== '‚Äî',
        'üè† Catastro':  datos['Total actas ingresadas']?.cat !== '‚Äî',
        'üåø Salud Amb.':datos['Total actas ingresadas']?.sal !== '‚Äî',
    };
    const colores = {
        'üöó Tr√°nsito':   '--transito',
        'üöî Tr. S√°bado': '--transito-sab',
        'üìã TMF':        '--tmf',
        'üõ°Ô∏è Def. Civil': '--defensa',
        'üè† Catastro':   '--catastro',
        'üåø Salud Amb.': '--salud',
    };

    let html = `
    <div class="fecha-bar">
        <button class="btn btn-nav" onclick="cambiarFecha(-1)">‚óÄ Anterior</button>
        <div>
            <label>Fecha</label>
            <input type="date" id="input-fecha" value="${fecha}" max="${hoy()}" onchange="cambiarFechaDirecta(this.value)">
        </div>
        <div>
            <label>D√≠a</label>
            <strong>${formatearFechaLegible(fecha)}</strong>
        </div>
        ${fecha !== hoy() ? `<button class="btn btn-nav" onclick="cambiarFecha(1)">Siguiente ‚ñ∂</button>` : ''}
        <button class="btn btn-hoy" onclick="cambiarFechaDirecta('${hoy()}')">üìÖ Hoy</button>
    </div>

    <div class="export-bar">
        <button class="btn-exp imp" onclick="window.print()">üñ®Ô∏è <span>Imprimir</span></button>
        <button class="btn-exp pdf" onclick="window.print()">üìÑ <span>PDF</span></button>
        <button class="btn-exp xls" onclick="exportarExcel('${fecha}')">üìä <span>Excel</span></button>
    </div>

    <div class="estado-mesas">`;

    for (const [nombre, cargado] of Object.entries(estados)) {
        const color = `var(${colores[nombre]})`;
        html += `<div class="estado-chip" style="border-color:${cargado ? color : '#f39c12'};color:${cargado ? color : '#e67e22'}">
            <div class="dot" style="background:${cargado ? color : '#f39c12'}"></div>
            ${nombre}
            <span style="font-size:11px;font-weight:400;color:${cargado ? '#666' : '#e67e22'}">${cargado ? 'Con datos' : 'Sin cargar'}</span>
        </div>`;
    }
    html += `</div>

    <div class="card">
        <div class="card-header">üèõÔ∏è Mesas de Entrada ‚Äî Comparativo del D√≠a</div>
        <div class="tabla-wrapper">
        <table class="tabla-resumen" id="tabla-exportar">
            <thead><tr>
                <th class="col-label">Indicador</th>
                <th class="th-ts">üöó Tr√°nsito Semana<br><small style="font-weight:400;opacity:0.85;">Lunes‚ÄìViernes</small></th>
                <th class="th-tsab">üöî Tr√°nsito S√°bado</th>
                <th class="th-def">üõ°Ô∏è Defensa Civil</th>
                <th class="th-cat">üè† Catastro</th>
                <th class="th-sal">üåø Salud Ambiental</th>
            </tr></thead>
            <tbody>

            <tr class="sec-titulo sec-actas"><td colspan="6">üìÑ ACTAS</td></tr>
            <tr>
                <td class="col-label">Total actas ingresadas</td>
                <td>${vg(datos,'Total actas ingresadas','ts')}</td>
                <td>${vg(datos,'Total actas ingresadas','tsab')}</td>
                <td>${vg(datos,'Total actas ingresadas','def')}</td>
                <td>${vg(datos,'Total actas ingresadas','cat')}</td>
                <td>${vg(datos,'Total actas ingresadas','sal')}</td>
            </tr>
            <tr>
                <td class="col-label sub">‚Ü≥ Turno Ma√±ana</td>
                <td>${v(datos,'Turno Ma√±ana','ts')}</td>
                <td class="sd">‚Äî</td><td colspan="3" class="sd">‚Äî</td>
            </tr>
            <tr>
                <td class="col-label sub">‚Ü≥ Turno Tarde</td>
                <td>${v(datos,'Turno Tarde','ts')}</td>
                <td class="sd">‚Äî</td><td colspan="3" class="sd">‚Äî</td>
            </tr>

            <tr class="sec-titulo sec-secuestros"><td colspan="6">üîí SECUESTROS / CLAUSURAS</td></tr>
            <tr>
                <td class="col-label">Con secuestro</td>
                <td>${vg(datos,'Con secuestro','ts')}</td>
                <td>${v(datos,'Con secuestro','tsab')}</td>
                <td class="sd">‚Äî</td><td class="sd">‚Äî</td><td class="sd">‚Äî</td>
            </tr>
            <tr>
                <td class="col-label">Sin secuestro</td>
                <td>${v(datos,'Sin secuestro','ts')}</td>
                <td>${v(datos,'Sin secuestro','tsab')}</td>
                <td class="sd">‚Äî</td><td class="sd">‚Äî</td><td class="sd">‚Äî</td>
            </tr>
            <tr>
                <td class="col-label">Veh√≠culos liberados</td>
                <td class="sd">‚Äî</td>
                <td>${v(datos,'Veh√≠culos liberados','tsab')}</td>
                <td class="sd">‚Äî</td><td class="sd">‚Äî</td><td class="sd">‚Äî</td>
            </tr>
            <tr>
                <td class="col-label">Clausura / Decomiso</td>
                <td class="sd">‚Äî</td><td class="sd">‚Äî</td><td class="sd">‚Äî</td><td class="sd">‚Äî</td>
                <td>${v(datos,'Clausura / Decomiso','sal')}</td>
            </tr>

            <tr class="sec-titulo sec-atencion"><td colspan="6">üë• ATENCI√ìN AL P√öBLICO</td></tr>
            <tr>
                <td class="col-label">Personas atendidas</td>
                <td>${vg(datos,'Personas atendidas','ts')}</td>
                <td>${v(datos,'Personas atendidas','tsab')}</td>
                <td class="sd">‚Äî</td><td class="sd">‚Äî</td><td class="sd">‚Äî</td>
            </tr>
            <tr>
                <td class="col-label sub">‚Ü≥ Turno Ma√±ana</td>
                <td>${v(datos,'  Turno Ma√±ana','ts')}</td>
                <td class="sd">‚Äî</td><td colspan="3" class="sd">‚Äî</td>
            </tr>
            <tr>
                <td class="col-label sub">‚Ü≥ Turno Tarde</td>
                <td>${v(datos,'  Turno Tarde','ts')}</td>
                <td class="sd">‚Äî</td><td colspan="3" class="sd">‚Äî</td>
            </tr>
            <tr>
                <td class="col-label">Consultas</td>
                <td>${v(datos,'Consultas','ts')}</td>
                <td class="sd">‚Äî</td><td class="sd">‚Äî</td>
                <td>${v(datos,'Consultas','cat')}</td>
                <td class="sd">‚Äî</td>
            </tr>

            <tr class="sec-titulo sec-sistemas"><td colspan="6">üíª SISTEMAS CIT / SAE</td></tr>
            <tr>
                <td class="col-label">Sistema CIT</td>
                <td class="sd">‚Äî</td><td class="sd">‚Äî</td><td class="sd">‚Äî</td>
                <td>${v(datos,'Sistema CIT','cat')}</td>
                <td>${v(datos,'Sistema CIT','sal')}</td>
            </tr>
            <tr>
                <td class="col-label">Sistema SAE</td>
                <td class="sd">‚Äî</td><td class="sd">‚Äî</td><td class="sd">‚Äî</td>
                <td>${v(datos,'Sistema SAE','cat')}</td>
                <td>${v(datos,'Sistema SAE','sal')}</td>
            </tr>
            <tr>
                <td class="col-label">Docs. digitalizados</td>
                <td class="sd">‚Äî</td><td class="sd">‚Äî</td><td class="sd">‚Äî</td>
                <td>${v(datos,'Docs digitalizados','cat')}</td>
                <td class="sd">‚Äî</td>
            </tr>

            <tr class="sec-titulo sec-juzgados"><td colspan="6">üèõÔ∏è DISTRIBUCI√ìN POR JUZGADO</td></tr>
            ${['I','II','III','IV','V','VI','VII','VIII','IX'].map(j => `
            <tr>
                <td class="col-label sub">Juzgado ${j}</td>
                <td>${v(datos,`Juzgado ${j}`,'ts')}</td>
                <td class="sd">‚Äî</td>
                <td>${v(datos,`Juzgado ${j}`,'def')}</td>
                <td>${v(datos,`Juzgado ${j}`,'cat')}</td>
                <td class="sd">‚Äî</td>
            </tr>`).join('')}

            </tbody>
        </table>
        </div>
    </div>

    <!-- TMF -->
    <div class="card">
        <div class="tmf-header">
            <div>
                <h2>üìã Mesa TMF</h2>
                <p>Tr√°mites ¬∑ Libre Deuda ¬∑ Cupones ¬∑ Atenci√≥n</p>
            </div>
            <span style="background:rgba(255,255,255,0.2);padding:5px 14px;border-radius:20px;font-size:13px;font-weight:600;">
                ${datos['Actas ingresadas'] ? '‚úÖ Con datos' : '‚è≥ Sin cargar'}
            </span>
        </div>
        <div class="tmf-grid">`;

    const bloques = [
        { titulo: 'üìÑ Actas', items: [['Ingresadas','Actas ingresadas'],['Reasignadas','Actas reasignadas']] },
        { titulo: 'üìú Libre Deuda', items: [['Automotor gen.','Libre deuda autom. gen.'],['Automotor ret.','Libre deuda autom. ret.'],['Catastro ret.','Libre deuda catastro ret.']] },
        { titulo: 'üí≥ Cupones', items: [['Generados','Cupones generados'],['Recibidos','Cupones recibidos'],['Manual','Cupones manual']] },
        { titulo: 'üë• Atenci√≥n', items: [['Personas atendidas','Personas atendidas'],['Consultas','Consultas'],['Mails OGV','Mails OGV']] },
    ];

    bloques.forEach(b => {
        html += `<div class="tmf-bloque"><div class="tmf-bloque-titulo">${b.titulo}</div>`;
        b.items.forEach(([lbl,key]) => {
            html += `<div class="tmf-fila"><span class="lbl">${lbl}</span><span class="num">${vc(datos,key)}</span></div>`;
        });
        html += `</div>`;
    });

    html += `</div><div class="tmf-juzgados">`;
    ['III','V','VIII'].forEach(j => {
        html += `<div class="juz-box">
            <div class="juz-titulo">JUZGADO ${j}</div>
            <div class="juz-numeros">
                <div><div class="juz-num ing">${vc(datos,`Juzgado ${j} ingresadas`)}</div><div class="juz-lbl">Ingresadas</div></div>
                <div class="juz-sep"></div>
                <div><div class="juz-num reas">${vc(datos,`Juzgado ${j} reasignadas`)}</div><div class="juz-lbl">Reasignadas</div></div>
            </div>
        </div>`;
    });

    html += `</div></div>

    <footer>
        ‚öñÔ∏è Tribunal Municipal de Faltas ¬∑ Municipalidad de San Miguel de Tucum√°n<br>
        Versi√≥n 1.0 ¬∑ Lanzamiento Marzo 2026 ¬∑ Desarrollado por <strong>David D√≠az de la Vega</strong>
    </footer>`;

    document.getElementById('loading').style.display = 'none';
    document.getElementById('contenido-datos').style.display = 'block';
    document.getElementById('contenido-datos').innerHTML = html;
}

function mostrarSinDatos(fecha) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('contenido-datos').style.display = 'block';
    document.getElementById('contenido-datos').innerHTML = `
        <div class="fecha-bar">
            <button class="btn btn-nav" onclick="cambiarFecha(-1)">‚óÄ Anterior</button>
            <div><label>Fecha</label><input type="date" id="input-fecha" value="${fecha}" max="${hoy()}" onchange="cambiarFechaDirecta(this.value)"></div>
            <div><label>D√≠a</label><strong>${formatearFechaLegible(fecha)}</strong></div>
            ${fecha !== hoy() ? `<button class="btn btn-nav" onclick="cambiarFecha(1)">Siguiente ‚ñ∂</button>` : ''}
            <button class="btn btn-hoy" onclick="cambiarFechaDirecta('${hoy()}')">üìÖ Hoy</button>
        </div>
        <div class="alert alert-warning">
            ‚è≥ No hay datos sincronizados para el ${formatearFechaLegible(fecha)}.
        </div>`;
}

function cambiarFecha(dias) {
    const f = new Date(fechaActual + 'T12:00:00');
    f.setDate(f.getDate() + dias);
    const nueva = f.toISOString().split('T')[0];
    if (nueva <= hoy()) { fechaActual = nueva; cargarDatos(fechaActual); }
}

function cambiarFechaDirecta(fecha) {
    if (fecha <= hoy()) { fechaActual = fecha; cargarDatos(fechaActual); }
}

function exportarExcel(fecha) {
    const tabla = document.getElementById('tabla-exportar');
    if (!tabla) return;
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.table_to_sheet(tabla);
    XLSX.utils.book_append_sheet(wb, ws, `Resumen ${fecha}`);
    XLSX.writeFile(wb, `resumen-mesas-${fecha}.xlsx`);
}
</script>
</body>
</html>
